# Решения проблем проекта

Этот документ описывает решения для всех проблем, которые мешали доработать проект.

## 1. Развертывание на сервере

### Проблема
Не было понимания, как развернуть бота на сервере компании в Docker.

### Решение
Создана полная Docker-конфигурация:

- **`docker/Dockerfile`** - образ бота с Python 3.12
- **`docker/docker-compose.yml`** - оркестрация всех сервисов:
  - Бот (основное приложение)
  - Redis (для будущего использования)
  - Nginx (для раздачи медиафайлов)
- **`docker/nginx.conf`** - конфигурация веб-сервера для медиафайлов

### Использование
```bash
docker-compose -f docker/docker-compose.yml up -d
```

Подробная инструкция в файле `DEPLOYMENT.md`.

## 2. Хранение медиафайлов

### Проблема
Фото и видео файлы нужно было где-то хранить, чтобы инженер мог открыть их по ссылке.

### Решение
Реализован сервис `MediaStorage` (`src/services/media_storage.py`):

- **Сохранение файлов** на диск сервера в структурированные директории
- **Генерация URL** для доступа к файлам через веб-сервер
- **Организация по типам**: photos/, videos/, models/
- **Организация по пользователям**: каждый пользователь имеет свою поддиректорию

### Как это работает
1. Пользователь отправляет фото/видео в Telegram
2. Бот скачивает файл через Telegram API
3. Файл сохраняется на диск с уникальным именем
4. Генерируется URL вида: `http://your-server.com/media/photos/user_id/timestamp_uuid.jpg`
5. URL сохраняется в заявке и отправляется инженеру

### Интеграция с Nginx
Nginx настроен для раздачи медиафайлов на порту 8000, что позволяет инженеру открывать файлы по прямой ссылке.

## 3. Обработка ошибок

### Проблема
Ошибки в работе бота приводили клиентов в тупиковую ситуацию.

### Решение
Реализован сервис `ErrorHandler` (`src/services/error_handler.py`):

- **Глобальный обработчик ошибок** - перехватывает все исключения
- **Понятные сообщения** пользователю вместо технических ошибок
- **Счетчик ошибок** - отслеживает повторяющиеся ошибки
- **Автоматическое восстановление** - предлагает начать заново командой `/start`
- **Уведомление инженера** при критических проблемах

### Механизм работы
1. При ошибке пользователь получает понятное сообщение
2. Предлагается начать заново через `/start`
3. После 3 ошибок подряд - уведомление инженеру
4. Все ошибки логируются для анализа

### Обработка ошибок в разговоре
- При ошибке в процессе заполнения заявки состояние очищается
- Пользователь может начать заново без потери данных (так как заявка не завершена)

## 4. Напоминания о брошенных заявках

### Проблема
Клиенты могут отвлечься во время оформления заявки (сообщение, звонок, разрядился телефон).

### Решение
Реализован сервис `ReminderService` (`src/services/reminder_service.py`):

- **Автоматическое планирование** напоминаний при начале заявки
- **Три этапа напоминаний**:
  - Через 30 минут
  - Через 1.5 часа
  - Через 1 день
- **Умные напоминания** - определяют, на каком этапе остановился пользователь
- **Автоматическая отмена** при завершении заявки

### Как это работает
1. Когда пользователь вводит имя, автоматически планируются напоминания
2. Если заявка не завершена через 30 минут - отправляется напоминание
3. Напоминание показывает, на каком этапе остановился пользователь
4. Предлагается продолжить через `/new_application`
5. После завершения заявки все напоминания отменяются

### Технические детали
- Используется `APScheduler` для планирования задач
- Напоминания хранятся в памяти (можно расширить до Redis)
- Автоматическая очистка устаревших напоминаний (старше 2 дней)

## Архитектура решения

### Новые сервисы

1. **MediaStorage** - управление медиафайлами
2. **ErrorHandler** - обработка ошибок
3. **ReminderService** - система напоминаний

### Интеграция

Все сервисы интегрированы через `services/context.py`, что позволяет:
- Доступ к сервисам из любого обработчика
- Единая точка инициализации в `main.py`
- Легкое тестирование и расширение

### Конфигурация

Новые переменные окружения:
- `MEDIA_STORAGE_PATH` - путь для хранения медиафайлов
- `BASE_URL` - базовый URL для доступа к файлам
- `REDIS_HOST`, `REDIS_PORT` - для будущего использования Redis

## Следующие шаги

1. **Тестирование на сервере** - развернуть и протестировать все функции
2. **Мониторинг** - настроить логирование и мониторинг ошибок
3. **Оптимизация** - при необходимости добавить Redis для хранения состояния
4. **Безопасность** - настроить HTTPS и ограничить доступ к медиафайлам

## Документация

- `DEPLOYMENT.md` - инструкция по развертыванию
- `SETUP_GITHUB.md` - работа с Git и GitHub
- `README.md` - общая информация о проекте

