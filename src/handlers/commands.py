from telegram import Update
from telegram.ext import ContextTypes
from ..models.application import Application
from ..utils.validators import validate_email, validate_phone


# –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞—è–≤–æ–∫ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ –∫—Ä–∞—â–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ë–î)
active_applications: dict[int, Application] = {}


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /start"""
    welcome_message = (
        "üëã <b>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ —Å–µ—Ä–≤—ñ—Å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä—É Bambu Lab –£–∫—Ä–∞—ó–Ω–∞!</b>\n\n"
        "–ù–∞—à —Å–µ—Ä–≤—ñ—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—Ü—ñ —Ç–∞ —Ä–µ–º–æ–Ω—Ç—ñ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è Bambu Lab.\n"
        "–ú–∏ –ø—Ä–∞—Ü—é—î–º–æ —É –±—É–¥–Ω—ñ –¥–Ω—ñ –∑ 9:00 –¥–æ 18:00.\n\n"
        "üìã <b>–Ø–∫ –º–∏ –≤–∏—Ä—ñ—à—É—î–º–æ –ø—Ä–æ–±–ª–µ–º–∏:</b>\n"
        "1. –í—ñ–¥–¥–∞–ª–µ–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è —á–µ—Ä–µ–∑ —Ç–µ–ª–µ–≥—Ä–∞–º –∞–±–æ —Ç–µ–ª–µ—Ñ–æ–Ω\n"
        "2. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è ‚Äî –∑–∞ –ø–æ—Ç—Ä–µ–±–∏ –º–∏ –Ω–∞–¥–∞–º–æ —Ç–µ—Å—Ç–æ–≤—É –º–æ–¥–µ–ª—å –¥–ª—è –¥—Ä—É–∫—É\n"
        "3. –§—ñ–∑–∏—á–Ω–∏–π —Ä–µ–º–æ–Ω—Ç ‚Äî —è–∫—â–æ –ø—Ä–æ–±–ª–µ–º—É –Ω–µ–º–æ–∂–ª–∏–≤–æ –≤–∏—Ä—ñ—à–∏—Ç–∏ –≤—ñ–¥–¥–∞–ª–µ–Ω–æ, "
        "–≤–∞–º –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø—Ä–∏—Å—Ç—Ä—ñ–π –¥–æ –Ω–∞—à–æ–≥–æ —Å–µ—Ä–≤—ñ—Å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä—É "
        "(–¥–æ—Å—Ç–∞–≤–∫–∞ –≤ –æ–±–∏–¥–≤–∞ –±–æ–∫–∏ –∑–∞ —Ä–∞—Ö—É–Ω–æ–∫ –∫–ª—ñ—î–Ω—Ç–∞)\n\n"
        "‚ÑπÔ∏è <b>–í–∞–∂–ª–∏–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</b>\n"
        "‚Ä¢ –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –∑–∞—è–≤–∫—É –Ω–∞–¥–∞—î—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º 2 —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤\n"
        "‚Ä¢ –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –Ω–∞–¥–∞—î—Ç—å—Å—è –∫–ª—ñ—î–Ω—Ç–∞–º, —è–∫—ñ –ø—Ä–∏–¥–±–∞–ª–∏ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è —É –Ω–∞—Å\n"
        "‚Ä¢ –°–µ—Ä–≤—ñ—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä –ø—Ä–∞—Ü—é—î –≤–∏–∫–ª—é—á–Ω–æ –∑ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è–º Bambu Lab\n"
        "‚Ä¢ –ì–∞—Ä–∞–Ω—Ç—ñ–π–Ω–∏–π —Ä–µ–º–æ–Ω—Ç –º–æ–∂–ª–∏–≤–∏–π –≤–∏–∫–ª—é—á–Ω–æ –¥–ª—è —Ç–æ–≤–∞—Ä—ñ–≤, –ø—Ä–∏–¥–±–∞–Ω–∏—Ö —É –Ω–∞—à–æ–º—É –º–∞–≥–∞–∑–∏–Ω—ñ\n"
        "‚Ä¢ –ì–∞—Ä–∞–Ω—Ç—ñ–π–Ω–∏–π —Ä–µ–º–æ–Ω—Ç –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤–∏–∫–ª—é—á–Ω–æ –Ω–∞ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó –Ω–∞—à–æ–≥–æ —Å–µ—Ä–≤—ñ—Å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä—É\n\n"
        "–î–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞—è–≤–∫–∏ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å /new_application"
    )

    await update.message.reply_text(
        welcome_message,
        parse_mode='HTML'
    )


async def new_application(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü–æ—á–∞—Ç–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –∑–∞—è–≤–∫–∏"""
    from .conversation import WAITING_NAME, ConversationHandler

    user_id = update.effective_user.id

    # –Ø–∫—â–æ –≤–∂–µ —î –∞–∫—Ç–∏–≤–Ω–∞ –∑–∞—è–≤–∫–∞, –≤–∏–¥–∞–ª—è—î–º–æ —ó—ó
    if user_id in active_applications:
        del active_applications[user_id]

    # –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É –∑–∞—è–≤–∫—É
    active_applications[user_id] = Application(user_id=user_id)

    await update.message.reply_text(
        "üìù <b>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –∑–∞—è–≤–∫–∏</b>\n\n"
        "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ <b>—ñ–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</b>:",
        parse_mode='HTML'
    )

    return WAITING_NAME


async def info(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /info"""
    info_message = (
        "‚ÑπÔ∏è <b>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å–µ—Ä–≤—ñ—Å–Ω–∏–π —Ü–µ–Ω—Ç—Ä</b>\n\n"
        "üìû <b>–†–µ–∂–∏–º —Ä–æ–±–æ—Ç–∏:</b> –±—É–¥–Ω—ñ –¥–Ω—ñ –∑ 9:00 –¥–æ 18:00\n\n"
        "‚è±Ô∏è <b>–¢–µ—Ä–º—ñ–Ω–∏ –æ–±—Ä–æ–±–∫–∏:</b>\n"
        "–í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –∑–∞—è–≤–∫—É –Ω–∞–¥–∞—î—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º 2 —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤\n\n"
        "üéØ <b>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∏:</b>\n"
        "–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –Ω–∞–¥–∞—î—Ç—å—Å—è –∫–ª—ñ—î–Ω—Ç–∞–º, —è–∫—ñ –ø—Ä–∏–¥–±–∞–ª–∏ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è —É –Ω–∞—Å\n\n"
        "üîß <b>–ì–∞—Ä–∞–Ω—Ç—ñ–π–Ω–∏–π —Ä–µ–º–æ–Ω—Ç:</b>\n"
        "‚Ä¢ –ú–æ–∂–ª–∏–≤–∏–π –≤–∏–∫–ª—é—á–Ω–æ –¥–ª—è —Ç–æ–≤–∞—Ä—ñ–≤, –ø—Ä–∏–¥–±–∞–Ω–∏—Ö —É –Ω–∞—à–æ–º—É –º–∞–≥–∞–∑–∏–Ω—ñ\n"
        "‚Ä¢ –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤–∏–∫–ª—é—á–Ω–æ –Ω–∞ —Ç–µ—Ä–∏—Ç–æ—Ä—ñ—ó –Ω–∞—à–æ–≥–æ —Å–µ—Ä–≤—ñ—Å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä—É\n"
        "‚Ä¢ –£–º–æ–≤–∏ –≥–∞—Ä–∞–Ω—Ç—ñ—ó –æ–ø–∏—Å–∞–Ω—ñ –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ\n\n"
        "–î–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞—è–≤–∫–∏ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å /new_application"
    )

    await update.message.reply_text(
        info_message,
        parse_mode='HTML'
    )


def register_commands(application):
    """–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞"""
    from telegram.ext import CommandHandler

    application.add_handler(CommandHandler("start", start))
    # new_application —Ä–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è –≤ ConversationHandler
    application.add_handler(CommandHandler("info", info))
